<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta name=viewport content="width=device-width,initial-scale=1"><title></title><meta name=author content="DevCows"><meta name=keywords content="devows,hugo,go"><meta name=description content="Site template made by devcows using hugo"><meta name=generator content="Hugo 0.81.0"><link href="//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800" rel=stylesheet type=text/css><link rel=stylesheet href=//use.fontawesome.com/releases/v5.11.2/css/all.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link href=/css/animate.css rel=stylesheet><link href=/css/style.turquoise.css rel=stylesheet id=theme-stylesheet><link href=/css/custom.css rel=stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link href=/css/owl.carousel.css rel=stylesheet><link href=/css/owl.theme.css rel=stylesheet><link rel=alternate href=https://dwnwrd.github.io/index.xml type=application/rss+xml title="dwnwrd Universal"><meta property="og:locale" content="en_us"><meta property="og:site_name" content="dwnwrd Universal"><meta property="og:title" content><meta property="og:type" content="article"><meta property="og:url" content="https://dwnwrd.github.io/blog/1/01/01/2020-06-05-openshift-x509-tls-trust-and-oc-login/"><meta property="og:description" content="Site template made by devcows using hugo"><meta property="og:image" content="https://dwnwrd.github.io/images/browser-cert-ingress.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="1496"><meta property="og:image:height" content="1156"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dlbewley"><meta name=twitter:title content><meta name=twitter:image content="https://dwnwrd.github.io/images/browser-cert-ingress.png"><meta name=twitter:description content="Site template made by devcows using hugo"></head><body><div id=all><header class=navbar-affixed-top data-spy=affix data-offset-top=62><div class="navbar navbar-default yamm" role=navigation id=navbar><div class=container><div class=navbar-header><a class="navbar-brand home" href=/><img src=/img/logo.png alt=" logo" class="hidden-xs hidden-sm">
<img src=/img/logo-small.png alt=" logo" class="visible-xs visible-sm">
<span class=sr-only>- go to homepage</span></a><div class=navbar-buttons><button type=button class="navbar-toggle btn-template-main" data-toggle=collapse data-target=#navigation>
<span class=sr-only>Toggle Navigation</span>
<i class="fas fa-align-justify"></i></button></div></div><div class="navbar-collapse collapse" id=navigation><ul class="nav navbar-nav navbar-right"><li class=dropdown><a href=/>Home</a></li><li class="dropdown active"><a href=/blog/>Blog</a></li><li class=dropdown><a href=/contact/>Contact</a></li></ul></div><div class="collapse clearfix" id=search><form class=navbar-form role=search><div class=input-group><input type=text class=form-control placeholder=Search>
<span class=input-group-btn><button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button></span></div></form></div></div></div></header><div id=heading-breadcrumbs><div class=container><div class=row><div class=col-md-12><h1></h1></div></div></div></div><div id=content><div class=container><div class=row><div class=col-md-9 id=blog-post><div id=post-content><div id=preamble><div class=sectionbody><div class=paragraph><p>This post will hopefully solve two or three problems for you.</p></div><div class="olist arabic"><ol class=arabic><li><p>Why do I see <em>"error: x509 certificate signed by unknown authority error"</em> when logging into OpenShift with <code>oc login</code>?</p></li><li><p>How can I trust the wildcard apps certificate used by my OpenShift ingress router?</p></li><li><p>I don’t grok TLS certificates.</p></li></ol></div></div></div><div class=sect1><h2 id=_problem_oc_login_returns_x509_certificate_signed_by_unknown_authority>Problem: oc login returns x509 certificate signed by unknown authority</h2><div class=sectionbody><div class=paragraph><p>Have you had this happen when logging in with <code>oc</code> or <code>kubectl</code>?</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ oc login -u $OCP_USERNAME -p $OCP_PASSWORD $OCP_SERVER
error: x509: certificate signed by unknown authority</code></pre></div></div><div class=paragraph><p>Then you thought "Oh, I know what to do!"</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ oc login --kubeconfig=kubeconfig -u $OCP_USERNAME -p $OCP_PASSWORD --insecure-skip-tls-verify=true $OCP_SERVER
error: x509: certificate signed by unknown authority # Whaaa?!</code></pre></div></div><div class=paragraph><p>Then realized, you are already logged in somehow!</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ oc whoami
system:admin</code></pre></div></div><div class=paragraph><p>What the heck is going on?</p></div><div class=paragraph><p>What does <em>"certificate signed by unknown authority"</em> this mean? It means your client does not trust the issuer (Certificate Authority) for a encypted endpoint involved in the login process. But there is a cert right there in the <em>kubeconfig</em> you say? And what endpoints are involved? And what is a certificate authority anyway? Let’s dig into that.</p></div><div class="admonitionblock tip"><table><tbody><tr><td class=icon><div class=title>Tip</div></td><td class=content><div class=title><strong>TLDR</strong></div>Logging in as <em>system:admin</em> uses a client certicate for auth and hits only <em>api.&lt;cluster>.&lt;domain></em> which is trusted, but logging in as a user with a password hits the OAuth route at <em>oauth-openshift-oauth.apps.&lt;cluster>.&lt;domain></em> which is not.</td></tr></tbody></table></div></div></div><div class=sect1><h2 id=_x_509_background>X.509 Background</h2><div class=sectionbody><div class=paragraph><p>First a little <a href=https://www.ssl.com/faqs/what-is-an-x-509-certificate/>background on X.509 certificates</a> and what "unknown authority" error means.</p></div><div class=paragraph><p>Any service using Transport Layer Secuiry encryption has a private key and a public certificate component. If data is encrypted using the public certificate, it can not be read without the private key. But how you know your client is encoding data for the public certificate of the service you are talking to and not a bad actor inserted in the data path?</p></div><div class=paragraph><p>If you access a site that has a certificate issued (signed) by an authority you do not recognize or trust then you can have no certainty that your data is not being easves dropped upon.</p></div><div class=paragraph><p>If the public certificate has a signature which you can verify then you can be sure of the provinance of the certificate. Most public web sites will have their certificates signed (issued) by a well known public <a href=https://en.wikipedia.org/wiki/Certificate_authority>certificate authority</a> like DigiCert or perhaps <a href=https://en.wikipedia.org/wiki/Let%27s_Encrypt>Let’s Encrypt</a>.</p></div><div class=paragraph><p><em>Why?</em> Because most people already trust signatures written by these authorities.
<em>How?</em> Because their public keys were already transfered to your computer using a secure mechanism such as bundling with your operating system or with your browser.</p></div><div class=sect2><h3 id=_google_example>Google Example</h3><div class=paragraph><p>First let’s look at the certificate for google.com. Notice it has a subject common name of <code>*.google.com</code> indicating it is a wildcard certificate. You can see it was issued by <code>GTS CA 101</code>. Additionally you can see the certificate will only remain valid for a period of 3 months.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ echo | openssl s_client -connect google.com:443 | openssl x509 -subject -issuer -dates -noout
depth=2 OU = GlobalSign Root CA - R2, O = GlobalSign, CN = GlobalSign
verify return:1
depth=1 C = US, O = Google Trust Services, CN = GTS CA 1O1
verify return:1
depth=0 C = US, ST = California, L = Mountain View, O = Google LLC, CN = *.google.com
verify return:1
DONE
subject= /C=US/ST=California/L=Mountain View/O=Google LLC/CN=*.google.com
issuer= /C=US/O=Google Trust Services/CN=GTS CA 1O1
notBefore=May 20 11:48:05 2020 GMT
notAfter=Aug 12 11:48:05 2020 GMT</code></pre></div></div><div class=paragraph><p>Look a little closer and you can see more than one certificate is presented when you access the site.
In this chain you can see there is certificate 0 and certificate 1. Each certificate has a subject <code>s</code> (who it represents) and an issuer <code>i</code> (who vouched for it).</p></div><div class=paragraph><p>In this example we trust the <code>*.google.com</code> certificate because we trust the <code>GTS CA 101</code>, and we trust that because we trust <code>GlobalSign</code>.</p></div><div class=paragraph><p>The GTS CA 101 certificate is known as an intermediate certificate. You typically don’t trust those directly. This is signed by the last certificate in this chain known as the root certificate. But there are only 2 shown below you say?</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ echo | openssl s_client -connect google.com:443 | head
depth=2 OU = GlobalSign Root CA - R2, O = GlobalSign, CN = GlobalSign
verify return:1
depth=1 C = US, O = Google Trust Services, CN = GTS CA 1O1
verify return:1
depth=0 C = US, ST = California, L = Mountain View, O = Google LLC, CN = *.google.com
verify return:1
DONE
CONNECTED(00000003)
---
Certificate chain
 0 s:/C=US/ST=California/L=Mountain View/O=Google LLC/CN=*.google.com
   i:/C=US/O=Google Trust Services/CN=GTS CA 1O1
 1 s:/C=US/O=Google Trust Services/CN=GTS CA 1O1
   i:/OU=GlobalSign Root CA - R2/O=GlobalSign/CN=GlobalSign
---
Server certificate
-----BEGIN CERTIFICATE-----</code></pre></div></div><div class=paragraph><p>The root certificate is not presented by the web server because you (hopefully) already have it on your computer and have tacitely agreed to trust it by way of your operating systems public key infrastructure.</p></div><div class=paragraph><p>This is the crux of our problem. The OpenShift cluster has more than one certificate authority which is issuing certificates for multiple services. This seperation allows for enhance security. Fortunately the OpenShift installer securely copied out the CA cert that was used to sign the API endpoint certificate. Wasn’t that enough?</p></div></div><div class=sect2><h3 id=_cluster_example>Cluster Example</h3><div class=paragraph><p>Let’s take a look at our API endpoint in the same way.</p></div><div class="admonitionblock important"><table><tbody><tr><td class=icon><div class=title>Important</div></td><td class=content><div class=title><a href=https://en.wikipedia.org/wiki/Server_Name_Indication>Server Name Identification</a> (vhosts for tls) is in use</div>Note that we have to provide the virtualhost name via the <code>-servername</code> argument to ensure we are talking to the right service and viewing the right certificate.</td></tr></tbody></table></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ echo | openssl s_client -connect api.aws-quick.aws.tofu.org:6443 -servername api.aws-quick.aws.tofu.org | head
depth=1 OU = openshift, CN = kube-apiserver-lb-signer
verify error:num=19:self signed certificate in certificate chain
verify return:0
DONE
CONNECTED(00000006)
---
Certificate chain
 0 s:/CN=api.aws-quick.aws.tofu.org
   i:/OU=openshift/CN=kube-apiserver-lb-signer
 1 s:/OU=openshift/CN=kube-apiserver-lb-signer
   i:/OU=openshift/CN=kube-apiserver-lb-signer
---
Server certificate
-----BEGIN CERTIFICATE-----</code></pre></div></div><div class=paragraph><p>You can also view this chain of 2 certificates in the browser by clicking the padlock icon in the location bar.</p></div><div class=imageblock><div class=content><img src=/images/browser-cert-api.png alt="browser-cert-api at api.cluster"></div></div><div class=paragraph><p>It looks like our API certificate is issued by <em>kube-apiserver-lb-signer</em> CA, and it’s a sure bet your operating system doesn’t know anything about this certificate authority yet.</p></div><div class=paragraph><p>The <em>kube-apiserver-lb-signer</em> CA cert was not installed with our browser or operating system and it didn’t even exist until the cluster was installed and it was not signed by any trusted authority that makes it a root certificate authority.</p></div></div></div></div><div class=sect1><h2 id=_certificate_use_in_openshift>Certificate use in OpenShift</h2><div class=sectionbody><div class=paragraph><p>I’m not going to plumb the depths of all uses of TLS in OpenShift which is of course used to ensure secure communication and identification throughout. But it turns out that even logging in interacts with more than one certificate authority.</p></div><div class=sect2><h3 id=_the_post_installation_kubeconfig>The Post-Installation kubeconfig</h3><div class=paragraph><p>When installing Openshift you should have <a href=https://github.com/dlbewley/homelab/blob/master/bin/ocp>collected a client config</a> file from <code>install-dir/auth/kubeconfig</code> which contains the CA certificate for "the cluster", and a client certificate for <code>system:admin</code> user which enables a login with no password require. Additionally <code>install-dir/auth/kubeadmin-password</code> contains the password for the <code>kubeadmin</code> user in the web console.</p></div><div class=paragraph><p>This <em>kubeconfig</em> file includes <code>base64</code> encoded values of multiple X.509 certificates. The Certificate Authority certificate for the cluster API endpoint is within <em>certificate-authority-data</em>. The admin user certiicate and private key are also visible in the user dictionary. Spoiler alert, there may be more than just those!</p></div><div class=listingblock><div class=title>The kubeconfig looks something like this:</div><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tL.&lt;snip&gt;.Qo=
    server: https://api.aws-quick.aws.tofu.org:6443
  name: quick
contexts:
- context:
    cluster: quick
    user: admin
  name: admin
current-context: admin
kind: Config
preferences: {}
users:
- name: admin
  user:
    client-certificate-data: LS0tL.&lt;snip&gt;.Qo=
    client-key-data: LS0tL.&lt;snip&gt;.g==</code></pre></div></div><div class=paragraph><p>Let’s extract these certificates and find the Certificate Authority for the API endpoint. Remember, we discovered above it should have a common name of <em>kube-apiserver-lb-signer</em>.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh># convert kubeconfig from yaml to json
$ cat kubeconfig | yq r -j - | jq -s &gt; kubeconfig.json
# pull the value from /clusters/cluster/certificate-authority-data
# and decode it
$ cat kubeconfig.json \
  | jq -r &#39;.[].clusters[0].cluster.&#34;certificate-authority-data&#34;&#39; \
  | base64 -d &gt; kubeconfig-ca-data.pem</code></pre></div></div><div class=paragraph><p>It turns out there are 3 certificates in the kubeconfig certificate-authority-data! We only care about one at the moment.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ grep BEGIN kubeconfig-ca-data.pem
-----BEGIN CERTIFICATE-----
-----BEGIN CERTIFICATE-----
-----BEGIN CERTIFICATE-----</code></pre></div></div><div class=paragraph><p>Because there are 3 certs in one file we have to get a little fancy and convert the file to an intermediary pkcs7 format. Otherwise we could seperate them each out into 3 files.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ openssl crl2pkcs7 -nocrl -certfile kubeconfig-ca-data.pem | openssl pkcs7 -print_certs -noout
subject=/OU=openshift/CN=kube-apiserver-localhost-signer
issuer=/OU=openshift/CN=kube-apiserver-localhost-signer

subject=/OU=openshift/CN=kube-apiserver-service-network-signer
issuer=/OU=openshift/CN=kube-apiserver-service-network-signer

subject=/OU=openshift/CN=kube-apiserver-lb-signer
issuer=/OU=openshift/CN=kube-apiserver-lb-signer</code></pre></div></div><div class=paragraph><p>Let’s reproduce the verification failure with <code>curl</code>.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ curl -I https://api.aws-quick.aws.tofu.org:6443
curl: (60) SSL certificate problem: self signed certificate in certificate chain
More details here: https://curl.haxx.se/docs/sslcerts.html

curl failed to verify the legitimacy of the server and therefore could not
establish a secure connection to it. To learn more about this situation and
how to fix it, please visit the web page mentioned above.</code></pre></div></div><div class=paragraph><p>Now let’s prove verification works with the cert(s) certificate-authority-data from kubeconfig.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ curl --cacert kubeconfig-ca-data.pem -I https://api.aws-quick.aws.tofu.org:6443
HTTP/2 403
audit-id: a5ab2f62-c1a0-4bda-b992-4531587ce9b5
content-type: application/json
x-content-type-options: nosniff
content-length: 234
date: Sat, 06 Jun 2020 22:13:31 GMT</code></pre></div></div><div class=paragraph><p>It worked! I hope you weren’t surprised.</p></div><div class=paragraph><p>While it isn’t totally relevant, let’s take a peek at the admin client certificate and see who issued it.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ cat kubeconfig \
  | yq r -j - \
  | jq -r &#39;.users[0].user.&#34;client-certificate-data&#34;&#39; \
  | base64 -d \
  | openssl x509 -noout -subject -issuer -dates
subject= /O=system:masters/CN=system:admin
issuer= /OU=openshift/CN=admin-kubeconfig-signer
notBefore=Jun  6 17:24:35 2020 GMT
notAfter=Jun  4 17:24:35 2030 GMT</code></pre></div></div><div class=paragraph><p>This demonstrates yet another CA called <em>admin-kubeconfig-signer</em>, but we can ignore that for ow.</p></div></div><div class=sect2><h3 id=_pump_up_the_logs>Pump up the logs</h3><div class=paragraph><p>Well, it looks like we have the right CA cert in kubeconfig, so what is the problem?!</p></div><div class=paragraph><p>If you turn up the loglevel on the oc login command and you will find that the API is sending you over to the OAuth service to be verified and to receive a token.</p></div><div class=paragraph><p>Oh shoot! It looks like OAuth is using a certificate authority we don’t know about.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ oc login -u $OCP_USERNAME -p $OCP_PASSWORD $OCP_SERVER --loglevel=6
I0605 17:17:14.214152   31550 loader.go:375] Config loaded from file:  /keybase/private/dlbewley/credz/ocp/bewley/kubeconfig
I0605 17:17:14.241262   31550 round_trippers.go:443] HEAD https://api.os.bewley.net:6443/ 403 Forbidden in 23 milliseconds
I0605 17:17:14.241467   31550 request_token.go:86] GSSAPI Enabled
I0605 17:17:14.244353   31550 round_trippers.go:443] GET https://api.os.bewley.net:6443/.well-known/oauth-authorization-server 200 OK in 2 milliseconds
I0605 17:17:14.314929   31550 round_trippers.go:443] HEAD https://oauth-openshift.apps.os.bewley.net  in 69 milliseconds
I0605 17:17:14.314952   31550 request_token.go:438] falling back to kubeconfig CA due to possible x509 error: x509: certificate signed by unknown authority
I0605 17:17:14.326346   31550 round_trippers.go:443] GET https://oauth-openshift.apps.os.bewley.net/oauth/authorize?client_id=openshift-challenging-client&amp;code_challenge=0jD-xcHh1bdlFjcUgZWzLMs_rsIuRp1EFy49BeCC8Lg&amp;code_challenge_method=S256&amp;redirect_uri=https%3A%2F%2Foauth-openshift.apps.os.bewley.net%2Foauth%2Ftoken%2Fimplicit&amp;response_type=code  in 11 milliseconds
I0605 17:17:14.331921   31550 round_trippers.go:443] GET https://api.os.bewley.net:6443/api/v1/namespaces/openshift/configmaps/motd 403 Forbidden in 3 milliseconds
F0605 17:17:14.494125   31550 helpers.go:114] error: x509: certificate signed by unknown authority</code></pre></div></div><div class=paragraph><p>Without using <code>oc</code> here is how to do the same.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ curl -sk https://api.aws-quick.aws.tofu.org:6443/.well-known/oauth-authorization-server | jq .authorization_endpoint
&#34;https://oauth-openshift.apps.aws-quick.aws.tofu.org/oauth/authorize&#34;
$ curl --cacert kubeconfig-ca-data.pem  https://oauth-openshift.apps.aws-quick.aws.tofu.org/
curl: (60) SSL certificate problem: self signed certificate in certificate chain</code></pre></div></div></div><div class=sect2><h3 id=_tls_ca_for_the_oauth_and_apps_endpoint>TLS CA for the Oauth and Apps Endpoint</h3><div class=paragraph><p>So what authority issued that certificate?</p></div><div class=paragraph><p>You can use openssl again or you can just browse to <code><a href="https://oauth-openshift.apps.<cluster>.<domain>" class=bare>https://oauth-openshift.apps.&lt;cluster>.&lt;domain></a>;</code> and look at the certificate to see that the CA for the oauth route is <em>ingress-operator@&lt;serialnumber></em>.</p></div><div class=paragraph><p>In fact this is the same wildcard certificate used by default on all the application routes.</p></div><div class=imageblock><div class=content><img src=/images/browser-cert-ingress.png alt="browser-cert-ingress at oauth.apps.cluster"></div></div><div class=paragraph><p><strong>So how can we get the ingress-operator@&lt;serialnumber> CA cert?</strong></p></div><div class="admonitionblock important"><table><tbody><tr><td class=icon><div class=title>Important</div></td><td class=content><div class=title><strong>Todo</strong></div>Better retrieval of CA cert and treatment of non-default setup.</td></tr></tbody></table></div><div class=ulist><ul><li><p>Where the cert is mounted</p></li></ul></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>oc rsh -n openshift-authentication deployment/oauth-openshift cat /run/secrets/kubernetes.io/serviceaccount/ca.crt</code></pre></div></div><div class=ulist><ul><li><p>Service account has secret associated</p></li></ul></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>oc get sa -n openshift-authentication oauth-openshift -o yaml</code></pre></div></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ oc extract secret/v4-0-config-system-router-certs -n openshift-authentication \
   --to - 2&gt;/dev/null &gt;router-cacert.pem</code></pre></div></div><div class=ulist><ul><li><p>Notice this contains 2 certs and a key. We want to protect that key, so we should not have even extracted it!</p></li></ul></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ grep BEGIN router-cacert.pem
-----BEGIN CERTIFICATE-----
-----BEGIN CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----

$ openssl crl2pkcs7 -nocrl -certfile router-cacert.pem | openssl pkcs7 -print_certs -noout
subject=/CN=*.apps.aws-quick.aws.tofu.org
issuer=/CN=ingress-operator@1591466269

subject=/CN=ingress-operator@1591466269
issuer=/CN=ingress-operator@1591466269</code></pre></div></div><div class=ulist><ul><li><p>Prove this CA lets us trust the OAuth endpoing</p></li></ul></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ curl -I --cacert router-cacert.pem  https://oauth-openshift.apps.aws-quick.aws.tofu.org/
HTTP/1.1 403 Forbidden
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Content-Type: application/json
Expires: 0
Pragma: no-cache
Referrer-Policy: strict-origin-when-cross-origin
X-Content-Type-Options: nosniff
X-Dns-Prefetch-Control: off
X-Frame-Options: DENY
X-Xss-Protection: 1; mode=block
Date: Sun, 07 Jun 2020 16:50:07 GMT
Content-Length: 234</code></pre></div></div><div class=paragraph><p>Now, if you add the ingress CA</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ oc --kubeconfig=kubeconfig login -u $OCP_USERNAME -p $OCP_PASSWORD --certificate-authority=router-cacert.pem
The server uses a certificate signed by an unknown authority.
You can bypass the certificate check, but any data you send to the server could be intercepted by others.
Use insecure connections? (y/n): y
oc --kubeconfig=kubeconfig whoami
kube:admin</code></pre></div></div></div></div></div><div class=sect1><h2 id=_fix_tls_trust_on_mac_osx>Fix TLS Trust on Mac OSX</h2><div class=sectionbody><div class=paragraph><p>Now that we have the CA certs let’s install them so our browser, <code>curl</code>, and <code>oc</code> will trust them to verify our cluster resources.</p></div><div class=sect2><h3 id=_install_and_trust_certificate_authorities>Install and Trust Certificate Authorities</h3><div class=paragraph><p>How do we get that to be trusted automatically?</p></div><div class=paragraph><p><strong>Instructions for Mac OS X Catalina</strong></p></div><div class=ulist><ul><li><p>Divide the kubeconfig-ca-data.pem file into 3 files. Call them kube-1.crt kube-2.crt kube-3.crt each including an individual certificate.</p></li></ul></div><div class="admonitionblock tip"><table><tbody><tr><td class=icon><div class=title>Tip</div></td><td class=content><div class=title><strong>Examine certificate contents</strong></div><div class=paragraph><p>Use <code>openssl</code> to read some attributes of the certificate for confirmation of the contents.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ openssl x509 -in kube-3.crt -noout -subject -issuer -dates -serial
subject= /OU=openshift/CN=kube-apiserver-lb-signer
issuer= /OU=openshift/CN=kube-apiserver-lb-signer
notBefore=Jun  6 17:24:36 2020 GMT
notAfter=Jun  4 17:24:36 2030 GMT
serial=568603E86E655777</code></pre></div></div></td></tr></tbody></table></div><div class=ulist><ul><li><p>Drag and drop each file onto the Keychain application or use <code>open kube-1.crt</code> on the command line and import them into the <em>"login"</em> keychain.</p></li><li><p>In Keychain certificates, search for "kube", and double cick on the certificate <em>"kube-apiserver-lb-signer"</em>. Set the trust policy to <em>"Always Trust"</em>. Keychain may not redraw the icon correctly so refresh or click around to confirm the change.</p></li></ul></div><div class=imageblock><div class=content><img src=/images/keychain-untrusted-kubesigner.png alt="keychain trust kubeconfig ca data"></div></div><div class=paragraph><p>You can also trust the other certs but they aren’t needed.</p></div><div class=paragraph><p>At this point you can restart your browser or use <code>curl</code> to confirm the API endpoint is trusted.</p></div><div class=imageblock><div class=content><img src=/images/browser-cert-api-trusted.png alt="browser trusts API cert"></div></div><div class=listingblock><div class=content><pre class=highlight><code class=language-sh data-lang=sh>$ curl  -I https://api.aws-quick.aws.tofu.org:6443
HTTP/2 403
audit-id: 84c23628-fab5-4af9-8542-658e9c998ef3
content-type: application/json
x-content-type-options: nosniff
content-length: 234
date: Sun, 07 Jun 2020 21:06:11 GMT</code></pre></div></div><div class=paragraph><p><strong>Now the Ingress</strong></p></div><div class=imageblock><div class=content><img src=/images/keychain-import.png alt="keychain import router certs"></div></div><div class=paragraph><p>Doublelick on ingress-operator
<a href="https://www.dropbox.com/s/nio7aaidjre6kmh/Screenshot%202020-06-05%2013.42.37.png?dl=0" class=bare>https://www.dropbox.com/s/nio7aaidjre6kmh/Screenshot%202020-06-05%2013.42.37.png?dl=0</a></p></div><div class=imageblock><div class=content><img src=/images/keychain-ingress-cert.png alt="keychain eval ingress cert"></div></div><div class=paragraph><p>Change <em>When using this certificate</em> from <em>Use System Defaults</em> to <em>Always Trust</em>
<a href="https://www.dropbox.com/s/azolm111dax2n3z/Screenshot%202020-06-05%2013.43.00.png?dl=0" class=bare>https://www.dropbox.com/s/azolm111dax2n3z/Screenshot%202020-06-05%2013.43.00.png?dl=0</a></p></div><div class=imageblock><div class=content><img src=/images/keychain-trust-cert.png alt="keychain trust ingress cert"></div></div><div class=paragraph><p>And now
oc --kubeconfig=kubeconfig login -u $OCP_USERNAME -p $OCP_PASSWORD
works and there is no need to pass in the cert and if you restart your browser then your apps will be trusted as well.</p></div><div class=paragraph><p><a href="https://www.dropbox.com/s/av4k3xfgg4k8pyp/Screenshot%202020-06-05%2014.20.54.png?dl=0" class=bare>https://www.dropbox.com/s/av4k3xfgg4k8pyp/Screenshot%202020-06-05%2014.20.54.png?dl=0</a></p></div><div class=imageblock><div class=content><img src=/images/keychain-trusted-cert.png alt="keychain trusted ingress cert"></div></div><div class=paragraph><p>Need to redo this without importing the wildcard cert. It is not needed.</p></div><div class=paragraph><p>Credit to <a href=https://access.redhat.com/solutions/4505101 class=bare>https://access.redhat.com/solutions/4505101</a></p></div></div></div></div></div><div id=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//dlbewleygithubio.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div class=col-md-3><div class="panel panel-default sidebar-menu"><div class=panel-heading><h3 class=panel-title>Search</h3></div><div class=panel-body><form action=//google.com/search method=get accept-charset=utf-8 role=search><div class=input-group><input type=search name=q class=form-control placeholder=Search>
<input type=hidden name=sitesearch value=https://dwnwrd.github.io/>
<span class=input-group-btn><button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button></span></div></form></div></div><div class="panel panel-default sidebar-menu"><div class=panel-heading><h3 class=panel-title>Categories</h3></div><div class=panel-body><ul class="nav nav-pills nav-stacked"><li><a href=/categories/lorem>lorem (1)</a></li><li><a href=/categories/programming>programming (2)</a></li><li><a href=/categories/pseudo>pseudo (1)</a></li><li><a href=/categories/starting>starting (1)</a></li></ul></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>Tags</h3></div><div class=panel-body><ul class=tag-cloud><li><a href=/tags/go><i class="fas fa-tags"></i>go</a></li><li><a href=/tags/golang><i class="fas fa-tags"></i>golang</a></li><li><a href=/tags/hugo><i class="fas fa-tags"></i>hugo</a></li><li><a href=/tags/ipsum><i class="fas fa-tags"></i>ipsum</a></li><li><a href=/tags/ocp4><i class="fas fa-tags"></i>ocp4</a></li><li><a href=/tags/openshift><i class="fas fa-tags"></i>openshift</a></li><li><a href=/tags/operators><i class="fas fa-tags"></i>operators</a></li><li><a href=/tags/programming><i class="fas fa-tags"></i>programming</a></li><li><a href=/tags/theme><i class="fas fa-tags"></i>theme</a></li></ul></div></div></div></div></div></div><footer id=footer><div class=container><div class="col-md-4 col-sm-6"><h4>About us</h4><p>Purveyor of fancy things since some time ago. Comments and opinions are my own and not that of my employers.</p><hr class="hidden-md hidden-lg hidden-sm"></div><div class="col-md-4 col-sm-6"><h4>Recent posts</h4><div class=blog-entries><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=https://dwnwrd.github.io/blog/2015/10/02/linked-post/><img src=/img/banners/banner-4.jpg class=img-responsive alt="Linked post"></a></div><div class="name same-height-always"><h5><a href=https://dwnwrd.github.io/blog/2015/10/02/linked-post/>Linked post</a></h5></div></div><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=https://dwnwrd.github.io/blog/2015/09/17/go-is-for-lovers/><img src=/img/banners/banner-2.jpg class=img-responsive alt="Go is for lovers"></a></div><div class="name same-height-always"><h5><a href=https://dwnwrd.github.io/blog/2015/09/17/go-is-for-lovers/>Go is for lovers</a></h5></div></div><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=https://dwnwrd.github.io/blog/2015/08/03/hugo-is-for-lovers/><img src=/img/banners/banner-3.jpg class=img-responsive alt="Hugo is for lovers"></a></div><div class="name same-height-always"><h5><a href=https://dwnwrd.github.io/blog/2015/08/03/hugo-is-for-lovers/>Hugo is for lovers</a></h5></div></div></div><hr class="hidden-md hidden-lg"></div><div class="col-md-4 col-sm-6"><h4>Contact</h4><p class=text-uppercase><strong>Dale Bewley</strong><br>Oakland<br>California<br><strong>USA</strong></p><a href=/contact class="btn btn-small btn-template-main">Go to contact page</a><hr class="hidden-md hidden-lg hidden-sm"></div></div></footer><div id=copyright><div class=container><div class=col-md-12><p class=pull-left>Copyright (c) 2021, Dale Bewley; all rights reserved.</p><p class=pull-right>Template by <a href=https://bootstrapious.com/p/universal-business-e-commerce-template>Bootstrapious</a>.
Ported to Hugo by <a href=https://github.com/devcows/hugo-universal-theme>DevCows</a>.</p></div></div></div></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-78084690-1','auto'),ga('send','pageview'))</script><script src=//code.jquery.com/jquery-3.1.1.min.js integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin=anonymous></script><script src=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js></script><script src="//maps.googleapis.com/maps/api/js?key=AIzaSyDacpwSIXi6lk2fS2wzZOSoh7iHm_ZP3UE&v=3.exp"></script><script src=/js/hpneo.gmaps.js></script><script src=/js/gmaps.init.js></script><script src=/js/front.js></script><script src=/js/owl.carousel.min.js></script></body></html>